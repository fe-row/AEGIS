services:
  # ══════════════════════════════════════════════════
  #  Core Services
  # ══════════════════════════════════════════════════

  # ── PostgreSQL ──
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: aegis
      POSTGRES_PASSWORD: ${DB_PASSWORD:-aegis_secret_2024}
      POSTGRES_DB: aegis
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./scripts/backup-postgres.sh:/backup.sh:ro
      - pgbackups:/backups
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U aegis" ]
      interval: 5s
      retries: 5
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "1.0"
    networks:
      - aegis-internal

  # ── Redis ──
  redis:
    image: redis:7-alpine
    command: redis-server --requirepass ${REDIS_PASSWORD} --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redisdata:/data
    healthcheck:
      test: [ "CMD-SHELL", "redis-cli -a ${REDIS_PASSWORD} ping | grep PONG" ]
      interval: 5s
      retries: 5
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 300M
          cpus: "0.5"
    networks:
      - aegis-internal

  # ── Open Policy Agent ──
  opa:
    image: openpolicyagent/opa:latest-static
    command:
      - "run"
      - "--server"
      - "--addr=0.0.0.0:8181"
      - "--log-level=info"
      - "/policies"
    volumes:
      - ./policies:/policies
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: "0.25"
    networks:
      - aegis-internal

  # ══════════════════════════════════════════════════
  #  Application
  # ══════════════════════════════════════════════════

  # ── Backend API ──
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      DATABASE_URL: postgresql+asyncpg://aegis:${DB_PASSWORD}@postgres:5432/aegis
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379/0
      OPA_URL: http://opa:8181
      JWT_SECRET: ${JWT_SECRET:-change-me-in-production-2024}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY:-}
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:3000,https://localhost}
      HITL_WEBHOOK_URL: ${HITL_WEBHOOK_URL:-}
      SLACK_WEBHOOK_URL: ${SLACK_WEBHOOK_URL:-}
      TEAMS_WEBHOOK_URL: ${TEAMS_WEBHOOK_URL:-}
      ENVIRONMENT: ${ENVIRONMENT:-production}
      # SSO
      SSO_ENABLED: ${SSO_ENABLED:-false}
      SSO_PROVIDER: ${SSO_PROVIDER:-}
      SSO_CLIENT_ID: ${SSO_CLIENT_ID:-}
      SSO_CLIENT_SECRET: ${SSO_CLIENT_SECRET:-}
      SSO_DISCOVERY_URL: ${SSO_DISCOVERY_URL:-}
      SSO_REDIRECT_URI: ${SSO_REDIRECT_URI:-}
      # OpenTelemetry
      OTEL_ENABLED: ${OTEL_ENABLED:-false}
      OTEL_EXPORTER_ENDPOINT: ${OTEL_EXPORTER_ENDPOINT:-http://jaeger:4317}
      OTEL_SERVICE_NAME: ${OTEL_SERVICE_NAME:-aegis-backend}
      # Alerting
      ALERT_PROVIDER: ${ALERT_PROVIDER:-}
      PAGERDUTY_ROUTING_KEY: ${PAGERDUTY_ROUTING_KEY:-}
      OPSGENIE_API_KEY: ${OPSGENIE_API_KEY:-}
      # Secrets Management
      SECRETS_PROVIDER: ${SECRETS_PROVIDER:-env}
      VAULT_ADDR: ${VAULT_ADDR:-}
      VAULT_TOKEN: ${VAULT_TOKEN:-}
      VAULT_SECRET_PATH: ${VAULT_SECRET_PATH:-secret}
      AWS_SECRET_NAME: ${AWS_SECRET_NAME:-}
    expose:
      - "8000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      opa:
        condition: service_started
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "2.0"
    networks:
      - aegis-internal

  # ── Frontend ──
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    environment:
      NEXT_PUBLIC_API_URL: https://${DOMAIN:-localhost}
    expose:
      - "3000"
    depends_on:
      - backend
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "1.0"
    networks:
      - aegis-internal

  # ══════════════════════════════════════════════════
  #  Edge / TLS
  # ══════════════════════════════════════════════════

  # ── Nginx Reverse Proxy ──
  nginx:
    image: nginx:1.27-alpine
    ports:
      - "80:80"
      - "443:443"
    environment:
      AEGIS_DOMAIN: ${DOMAIN:-localhost}
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/templates/default.conf.template:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - certbot-webroot:/var/www/certbot:ro
      - certbot-certs:/etc/letsencrypt:ro
    depends_on:
      - backend
      - frontend
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: "0.5"
    networks:
      - aegis-internal
      - default

  # ── Certbot (Let's Encrypt auto-renewal) ──
  certbot:
    image: certbot/certbot:latest
    volumes:
      - certbot-webroot:/var/www/certbot
      - certbot-certs:/etc/letsencrypt
    # Attempt renewal every 12h. Will no-op if cert is not near expiry.
    entrypoint: /bin/sh -c "trap exit TERM; while :; do certbot renew --webroot -w /var/www/certbot --quiet; sleep 12h & wait $${!}; done"
    depends_on:
      - nginx
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 64M
          cpus: "0.1"
    profiles:
      - production

  # ══════════════════════════════════════════════════
  #  Scheduled Tasks
  # ══════════════════════════════════════════════════

  # ── PostgreSQL Backup (daily at 3 AM) ──
  backup:
    image: postgres:16-alpine
    volumes:
      - ./scripts/backup-postgres.sh:/backup.sh:ro
      - pgbackups:/backups
    environment:
      POSTGRES_USER: aegis
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: aegis
      BACKUP_RETENTION_DAYS: 7
    entrypoint: |
      /bin/sh -c "chmod +x /backup.sh && trap exit TERM;
      echo 'Backup service started. Waiting for 3:00 AM schedule...';
      while :; do
        CURRENT_HOUR=$$(date +%H);
        if [ \"$$CURRENT_HOUR\" = \"03\" ]; then
          /backup.sh;
          sleep 3600;
        fi;
        sleep 1800 & wait $$!;
      done"
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.5"
    networks:
      - aegis-internal

  # ══════════════════════════════════════════════════
  #  Monitoring
  # ══════════════════════════════════════════════════

  # ── Prometheus ──
  prometheus:
    image: prom/prometheus:v2.51.0
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.retention.time=30d"
      - "--storage.tsdb.retention.size=1GB"
    expose:
      - "9090"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
    networks:
      - aegis-internal

  # ── Grafana ──
  grafana:
    image: grafana/grafana:10.4.0
    environment:
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-aegis-grafana-2024}
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_SERVER_ROOT_URL: https://${DOMAIN:-localhost}/grafana/
      GF_SERVER_SERVE_FROM_SUB_PATH: "true"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
    expose:
      - "3000"
    depends_on:
      - prometheus
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.5"
    networks:
      - aegis-internal

  # ══════════════════════════════════════════════════
  #  Distributed Tracing (optional)
  # ══════════════════════════════════════════════════

  # ── Jaeger (OpenTelemetry collector) ──
  jaeger:
    image: jaegertracing/all-in-one:1.54
    environment:
      COLLECTOR_OTLP_ENABLED: "true"
    expose:
      - "4317" # OTLP gRPC
      - "16686" # Jaeger UI
    ports:
      - "16686:16686" # Jaeger UI accessible from host
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.5"
    profiles:
      - tracing
    networks:
      - aegis-internal

# ══════════════════════════════════════════════════
#  Volumes
# ══════════════════════════════════════════════════
volumes:
  pgdata:
  pgbackups:
  redisdata:
  certbot-webroot:
  certbot-certs:
  prometheus-data:
  grafana-data:

    # ══════════════════════════════════════════════════
    #  Networks
    # ══════════════════════════════════════════════════
networks:
  aegis-internal:
    driver: bridge
